<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Maze Captcha System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: #1a1a1a;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        h1 {
            color: #ffffff;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #888888;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 60px;
        }
        
        .section {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 8px;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #ffffff;
            margin-bottom: 20px;
            border-bottom: 2px solid #333333;
            padding-bottom: 10px;
            font-weight: 600;
        }
        
        .captcha-container {
            text-align: center;
            margin: 20px 0;
        }
        
        #mazeCanvas {
            border: 2px solid #333333;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
            background: #ffffff;
        }
        
        .verify-section {
            text-align: center;
            margin: 20px 0;
        }
        
        .controls {
            display: flex;
            gap: 18px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button {
            padding: 12px 25px;
            border: 2px solid #333333;
            background: #2a2a2a;
            color: #ffffff;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        button:hover {
            background: #0052cc;
            border-color: #0052cc;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #2a2a2a;
            border: 1px solid #333333;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #333333;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
            border-radius: 8px;
        }
        
        .status.success {
            background: #1a3a1a;
            color: #4ade80;
            border: 2px solid #4ade80;
        }
        
        .status.error {
            background: #3a1a1a;
            color: #f87171;
            border: 2px solid #f87171;
        }
        
        .status.info {
            background: #1a2a3a;
            color: #60a5fa;
            border: 2px solid #60a5fa;
        }
        
        .hidden {
            display: none;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #2a2a2a;
            padding: 20px;
            text-align: center;
            border: 1px solid #333333;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0066ff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #888888;
            font-size: 0.9rem;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
            background: #2a2a2a;
            padding: 15px;
            border: 1px solid #333333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Production Maze Captcha System</h1>
            <div class="subtitle">AI-Powered Bot Detection with Human Behavior Learning</div>
        </header>
        
        <div class="main-content">
            <section class="section">
                <h2 class="section-title">Captcha Challenge</h2>
                
                <div class="captcha-container">
                    <canvas id="mazeCanvas" width="400" height="400"></canvas>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #00ff00;"></div>
                        <span>Start</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff0000;"></div>
                        <span>End</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #0066ff;"></div>
                        <span>Your Path</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button onclick="loadNewCaptcha()">New Captcha</button>
                    <button onclick="clearPath()">Clear Path</button>
                    <button onclick="verifySolution()">Verify Solution</button>
                    <button onclick="simulateBot()">Simulate Bot</button>
                </div>
                
                <div class="verify-section">
                    <button onclick="verifySolution()" disabled>Verify Solution</button>
                </div>
                
                <div id="status" class="status hidden"></div>
            </section>
            
            <section class="section">
                <h2 class="section-title">Real-Time Analytics</h2>
                
                <div class="analytics-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalAttempts">0</div>
                        <div class="stat-label">Total Attempts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="successRate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="botDetected">0</div>
                        <div class="stat-label">Bots Detected</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="patternsLearned">0</div>
                        <div class="stat-label">Patterns Learned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgSolveTime">0s</div>
                        <div class="stat-label">Avg Solve Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="learnedPatterns">0</div>
                        <div class="stat-label">Learned Patterns</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="performanceChart"></canvas>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Global variables
        var currentCaptcha = null;
        var userPath = [];
        var isDrawing = false;
        var mazeImage = null;
        var analyticsData = null;
        var performanceChart = null;
        
        // Canvas setup
        var canvas = document.getElementById('mazeCanvas');
        var ctx = canvas.getContext('2d');
        
        // Initialize charts
        function initCharts() {
            var perfCtx = document.getElementById('performanceChart');
            if (perfCtx) {
                performanceChart = new Chart(perfCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Successful', 'Failed', 'Bot Detected'],
                        datasets: [{
                            data: [0, 0, 0],
                            backgroundColor: ['#4ade80', '#f87171', '#fbbf24'],
                            borderColor: ['#22c55e', '#dc2626', '#f59e0b'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        // Load new captcha
        function loadNewCaptcha() {
            fetch('/api/captcha?difficulty=medium', {
                credentials: 'same-origin'
            })
                .then(function(response) {
                    return response.json();
                })
                .then(function(captcha) {
                    if (captcha.error) {
                        showStatus('Error: ' + captcha.error, 'error');
                        return;
                    }
                    
                    currentCaptcha = captcha;
                    userPath = [];
                    isDrawing = false;
                    
                    // Load maze image
                    mazeImage = new Image();
                    mazeImage.onload = function() {
                        drawMaze();
                        showStatus('New captcha loaded! Draw a path from green to red.', 'info');
                    };
                    mazeImage.src = captcha.maze_image;
                })
                .catch(function(error) {
                    showStatus('Error loading captcha. Please try again.', 'error');
                });
        }
        
        // Draw maze
        function drawMaze() {
            if (!mazeImage) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(mazeImage, 0, 0);
            
            // Draw user path
            if (userPath.length > 0) {
                ctx.strokeStyle = '#0066ff';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                ctx.beginPath();
                ctx.moveTo(userPath[0].x, userPath[0].y);
                
                for (var i = 1; i < userPath.length; i++) {
                    ctx.lineTo(userPath[i].x, userPath[i].y);
                }
                
                ctx.stroke();
            }
            
            // Draw bot path if exists
            if (typeof botPath !== 'undefined' && botPath.length > 0) {
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.setLineDash([5, 5]);
                
                // Convert maze coordinates to pixel coordinates
                var startX = botPath[0][1] * 20 + 10; // col to x
                var startY = botPath[0][0] * 20 + 10; // row to y
                
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                
                for (var i = 1; i < botPath.length; i++) {
                    var x = botPath[i][1] * 20 + 10; // col to x
                    var y = botPath[i][0] * 20 + 10; // row to y
                    ctx.lineTo(x, y);
                }
                
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
        
        // Canvas mouse events
        canvas.addEventListener('mousedown', function(e) {
            if (!currentCaptcha) return;
            
            var rect = canvas.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            
            isDrawing = true;
            userPath = [{x: x, y: y}];
            drawMaze();
        });

        canvas.addEventListener('mousemove', function(e) {
            if (!isDrawing) return;
            
            var rect = canvas.getBoundingClientRect();
            var x = e.clientX - rect.left;
            var y = e.clientY - rect.top;
            
            if (userPath.length === 0 || 
                Math.abs(x - userPath[userPath.length - 1].x) > 5 ||
                Math.abs(y - userPath[userPath.length - 1].y) > 5) {
                userPath.push({x: x, y: y});
                drawMaze();
            }
        });

        canvas.addEventListener('mouseup', function() {
            isDrawing = false;
        });

        canvas.addEventListener('mouseleave', function() {
            isDrawing = false;
        });
        
        // Clear path
        function clearPath() {
            userPath = [];
            botPath = [];
            isDrawing = false;
            drawMaze();
            showStatus('Path cleared. Start drawing from green square.', 'info');
        }
        
        // Verify solution
        function verifySolution() {
            if (!currentCaptcha) {
                showStatus('Please load a captcha first.', 'error');
                return;
            }
            
            if (userPath.length < 2) {
                showStatus('Please draw a path from start to end.', 'error');
                return;
            }
            
            showStatus('Analyzing your solution...', 'info');
            
            fetch('/api/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    captcha_id: currentCaptcha.captcha_id,
                    path: userPath.map(function(point) {
                        return [Math.floor(point.x / 20), Math.floor(point.y / 20)];
                    })
                })
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(result) {
                if (result.success) {
                    showStatus('Success: ' + result.message + ' (Confidence: ' + (result.analysis.confidence * 100).toFixed(1) + '%)', 'success');
                    setTimeout(loadNewCaptcha, 2000);
                } else {
                    showStatus('Error: ' + result.message + ' (Confidence: ' + (result.analysis.confidence * 100).toFixed(1) + '%)', 'error');
                }
                
                updateAnalytics();
            })
            .catch(function(error) {
                showStatus('Error verifying solution. Please try again.', 'error');
                console.error('Error verifying solution:', error);
            });
        }
        
        // Simulate bot
        function simulateBot() {
            console.log('simulateBot called, currentCaptcha:', currentCaptcha);
            if (!currentCaptcha) {
                showStatus('Please load a captcha first.', 'error');
                return;
            }
            
            console.log('Attempting bot simulation with captcha_id:', currentCaptcha.captcha_id);
            showStatus('Simulating bot behavior...', 'info');
            
            fetch('/api/bot-simulate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    captcha_id: currentCaptcha.captcha_id
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .catch(function(error) {
                console.error('Fetch error:', error);
                showStatus('Network error: ' + error.message, 'error');
                throw error;
            })
            .then(function(result) {
                console.log('Bot simulation response:', result);
                if (result.verification_result && result.verification_result.analysis) {
                    var analysis = result.verification_result.analysis;
                    var confidence = (analysis.confidence * 100).toFixed(1);
                    var detected = analysis.is_human ? 'Human' : 'Bot';
                    showStatus('Bot simulation complete: ' + detected + ' detected (Confidence: ' + confidence + '%)', analysis.is_human ? 'error' : 'success');
                    
                    // Draw bot path
                    if (result.bot_path && result.bot_path.length > 0) {
                        botPath = result.bot_path;
                        drawMaze();
                    }
                } else if (result.success === false) {
                    showStatus('Bot simulation failed: ' + (result.message || 'Unknown error'), 'error');
                } else {
                    console.log('Unexpected response structure:', result);
                    showStatus('Bot simulation failed - unexpected response', 'error');
                }
                
                updateAnalytics();
            })
            .catch(function(error) {
                showStatus('Error simulating bot. Please try again.', 'error');
                console.error('Error simulating bot:', error);
            });
        }
        
        // Update analytics
        function updateAnalytics() {
            fetch('/api/analytics')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    analyticsData = data;
                    
                    // Update stats
                    var totalAttempts = (data.successful_verifications || 0) + (data.bot_detected || 0);
                    document.getElementById('totalAttempts').textContent = totalAttempts;
                    document.getElementById('botDetected').textContent = data.bot_detected || 0;
                    document.getElementById('patternsLearned').textContent = data.learning_status ? data.learning_status.behaviors_learned : 0;
                    document.getElementById('learnedPatterns').textContent = data.human_patterns ? data.human_patterns.length : 0;
                    
                    // Calculate success rate
                    var successRate = totalAttempts > 0 ? 
                        ((data.successful_verifications / totalAttempts) * 100).toFixed(1) : 0;
                    document.getElementById('successRate').textContent = successRate + '%';
                    
                    // Update average solve time
                    var avgTime = data.learning_status ? data.learning_status.avg_human_solve_time : 0;
                    document.getElementById('avgSolveTime').textContent = avgTime.toFixed(1) + 's';
                    
                    // Update performance chart
                    if (performanceChart && data) {
                        performanceChart.data.datasets[0].data = [
                            data.successful_verifications || 0,
                            totalAttempts - (data.successful_verifications || 0) - (data.bot_detected || 0),
                            data.bot_detected || 0
                        ];
                        performanceChart.update();
                    }
                })
                .catch(function(error) {
                    console.error('Error updating analytics:', error);
                });
        }
        
        // Show status message
        function showStatus(message, type) {
            var statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
            statusDiv.classList.remove('hidden');
            
            if (type === 'info') {
                setTimeout(function() {
                    if (statusDiv.classList.contains('info')) {
                        statusDiv.classList.add('hidden');
                    }
                }, 5000);
            }
        }
        
        // Initialize page
        window.onload = function() {
            console.log('Page fully loaded');
            initCharts();
            loadNewCaptcha();
            updateAnalytics();
            
            // Update analytics every 10 seconds
            setInterval(updateAnalytics, 10000);
        };
    </script>
</body>
</html>